name: Deploy to GCP VM Instance

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  VM_INSTANCE_NAME: ${{ secrets.VM_INSTANCE_NAME }}
  VM_ZONE: ${{ secrets.VM_ZONE }}
  APP_NAME: feedshop-backend
  DEPLOY_PATH: /home/deploy/feedshop-backend

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "gradle"

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Application
        run: ./gradlew clean build -x test
        env:
          SPRING_PROFILES_ACTIVE: prod

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Create deployment package
        run: |
          echo "Creating deployment package..."
          mkdir -p deploy-package

          # JAR íŒŒì¼ ë³µì‚¬
          cp build/libs/*.jar deploy-package/app.jar

          # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
          cat > deploy-package/.env << EOF
          # Spring App
          SPRING_APPLICATION_NAME=feedShop

          # DB Connection
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}

          # JWT
          JWT_SECRET=${{ secrets.JWT_SECRET }}

          # Mailgun
          MAILGUN_API_KEY=${{ secrets.MAILGUN_API_KEY }}
          MAILGUN_DOMAIN=${{ secrets.MAILGUN_DOMAIN }}
          MAILGUN_EMAIL=${{ secrets.MAILGUN_EMAIL }}

          # GCS
          GCS_ID=${{ secrets.GCS_ID }}
          GCS_BUCKET=${{ secrets.GCS_BUCKET }}

          # OAuth
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
          KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}
          KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}

          # Other
          RECAPTCHA_SECRET_KEY=${{ secrets.RECAPTCHA_SECRET_KEY }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          APP_VERIFICATION_URL=${{ secrets.APP_VERIFICATION_URL }}
          APP_CDN_BASE_URL=${{ secrets.APP_CDN_BASE_URL }}
          EOF

          # docker-compose.yml ìƒì„±
          cat > deploy-package/docker-compose.yml << 'EOF'
          services:
            feedshop-backend:
              build: .
              container_name: feedshop-backend
              ports:
                - "8080:8080"
              env_file:
                - .env
              networks:
                - feedshop-network
              restart: unless-stopped

          networks:
            feedshop-network:
              driver: bridge
          EOF

          # Dockerfile ë³µì‚¬
          cp Dockerfile deploy-package/

          # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
          cat > deploy-package/deploy.sh << 'EOF'
          #!/bin/bash
          set -e
  
          echo "=== FeedShop Backend Deployment Starting ==="
          echo "Timestamp: $(date)"

          # í˜„ì¬ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          echo "Current container status:"
          sudo docker-compose ps || true
  
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
          echo "Stopping existing containers gracefully..."
          sudo docker-compose down --remove-orphans || true
  
          # ì´ë¯¸ì§€ ì •ë¦¬
          echo "Cleaning up old images..."
          sudo docker system prune -f || true
  
          # ìƒˆ ì»¨í…Œì´ë„ˆ ë¹Œë“œ ë° ì‹œì‘
          echo "Building and starting new containers..."
          sudo docker-compose up -d --build
  
          # ì»¨í…Œì´ë„ˆ ìƒíƒœë§Œ í™•ì¸
          echo "Checking container status..."
          sleep 10
          sudo docker-compose ps
  
          echo "Deployment completed!"
          echo "Container logs (last 20 lines):"
          sudo docker-compose logs --tail=20 feedshop-backend
          EOF
  
          chmod +x deploy-package/deploy.sh

      - name: Copy files to VM instance
        run: |
          echo "Copying deployment package to VM..."
          
          # VMì— ë°°í¬ ë””ë ‰í„°ë¦¬ ìƒì„±
          gcloud compute ssh $VM_INSTANCE_NAME \
            --zone=$VM_ZONE \
            --command="sudo mkdir -p $DEPLOY_PATH && sudo chown -R \$USER:\$USER $DEPLOY_PATH"
          
          # íŒŒì¼ ë³µì‚¬
          gcloud compute scp --recurse deploy-package/* \
            $VM_INSTANCE_NAME:$DEPLOY_PATH \
            --zone=$VM_ZONE

      - name: Deploy application on VM
        run: |
          echo "Deploying application on VM..."
          
          gcloud compute ssh $VM_INSTANCE_NAME \
            --zone=$VM_ZONE \
            --command="
              cd $DEPLOY_PATH && 
              echo '=== Starting deployment ===' &&
              chmod +x deploy.sh &&
              ./deploy.sh
            "

      - name: Verify deployment and setup monitoring
        run: |
          echo "Setting up external access and final verification..."
          
          # VMì˜ ì™¸ë¶€ IP ê°€ì ¸ì˜¤ê¸°
          VM_EXTERNAL_IP=$(gcloud compute instances describe $VM_INSTANCE_NAME \
            --zone=$VM_ZONE \
            --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
          
          echo "VM External IP: $VM_EXTERNAL_IP"
          
          # ë°©í™”ë²½ ê·œì¹™ í™•ì¸
          if gcloud compute firewall-rules describe allow-feedshop-8080 > /dev/null 2>&1; then
            echo "Firewall rule for port 8080 already exists"
          else
            echo "Warning: Firewall rule for port 8080 not found. Please create manually."
          fi
          
          # ì„œë¹„ìŠ¤ URL ì„¤ì •
          SERVICE_URL="http://$VM_EXTERNAL_IP:8080"
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_ENV
          
          echo "Deployment completed!"
          echo "ğŸ”— Service URL: $SERVICE_URL"
          echo "ğŸ“– API Docs: $SERVICE_URL/swagger-ui/index.html"

  notification:
    needs: deploy
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Notify Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "ğŸš€ Deployment to VM completed successfully!"
            echo "ğŸ“Š Instance: ${{ env.VM_INSTANCE_NAME }}"
            echo "ğŸŒ Zone: ${{ env.VM_ZONE }}"
            echo "ğŸ”— URL: ${{ env.SERVICE_URL }}"
            echo ""
            echo "ğŸ” Next steps:"
            echo "1. Check service health: ${{ env.SERVICE_URL }}/actuator/health"
            echo "2. View API docs: ${{ env.SERVICE_URL }}/swagger-ui/index.html"
            echo "3. Monitor logs: gcloud compute ssh ${{ env.VM_INSTANCE_NAME }} --zone=${{ env.VM_ZONE }} --command='sudo docker-compose -f ${{ env.DEPLOY_PATH }}/docker-compose.yml logs -f feedshop-backend'"
          else
            echo "âŒ Deployment failed!"
            echo "Please check the deployment logs and troubleshoot."
            exit 1
          fi