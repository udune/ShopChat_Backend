name: Deploy to GCP VM Instance

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  VM_INSTANCE_NAME: ${{ secrets.VM_INSTANCE_NAME }}
  VM_ZONE: ${{ secrets.VM_ZONE }}
  APP_NAME: feedshop-backend
  DEPLOY_PATH: /home/deploy/feedshop-backend

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "gradle"

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Application
        run: ./gradlew clean build -x test
        env:
          SPRING_PROFILES_ACTIVE: prod

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Create deployment package
        run: |
          echo "Creating deployment package..."
          mkdir -p deploy-package
          
          # JAR ÌååÏùº Î≥µÏÇ¨
          cp build/libs/*.jar deploy-package/app.jar
          
          # Dockerfile ÏÉùÏÑ± (ÏµúÏ†ÅÌôîÎêú Î≤ÑÏ†Ñ)
          cat > deploy-package/Dockerfile << 'EOF'
          FROM eclipse-temurin:17-jre-alpine
          
          # ÌïÑÏöîÌïú Ìå®ÌÇ§ÏßÄ ÏÑ§Ïπò
          RUN apk add --no-cache curl
          
          WORKDIR /app
          COPY app.jar app.jar
          
          EXPOSE 8080
          
          # JVM ÏµúÏ†ÅÌôî ÏòµÏÖò
          ENV JAVA_OPTS="-Xmx2g -Xms1g -XX:+UseG1GC -XX:+UseStringDeduplication -Djava.security.egd=file:/dev/./urandom"
          
          # Ìó¨Ïä§Ï≤¥ÌÅ¨ Ï∂îÍ∞Ä
          HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
            CMD curl -f http://localhost:8080/actuator/health || exit 1
          
          ENTRYPOINT ["sh", "-c", "echo '=== FeedShop Starting ===' && exec java $JAVA_OPTS -jar app.jar"]
          EOF
          
          # .env ÌååÏùº ÏÉùÏÑ± (ÌôòÍ≤ΩÎ≥ÄÏàò Ï§ëÏïô Í¥ÄÎ¶¨)
          cat > deploy-package/.env << EOF
          # Database Configuration
          DB_HOST=${{ secrets.VM_DB_HOST }}
          DB_PORT=${{ secrets.VM_DB_PORT }}
          DB_NAME=${{ secrets.VM_DB_NAME }}
          DB_USERNAME=${{ secrets.VM_DB_USERNAME }}
          DB_PASSWORD=${{ secrets.VM_DB_PASSWORD }}
          
          # JWT Configuration
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          
          # Mailgun Configuration
          MAILGUN_API_KEY=${{ secrets.MAILGUN_API_KEY }}
          MAILGUN_DOMAIN=${{ secrets.MAILGUN_DOMAIN }}
          MAILGUN_EMAIL=${{ secrets.MAILGUN_EMAIL }}
          
          # reCAPTCHA Configuration
          RECAPTCHA_SECRET_KEY=${{ secrets.RECAPTCHA_SECRET_KEY }}
          
          # OpenAI Configuration
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          
          # GCP Configuration
          GCS_ID=${{ secrets.GCS_ID }}
          GCS_BUCKET=${{ secrets.GCS_BUCKET }}
          
          # OAuth2 Configuration
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
          KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}
          KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}
          
          # Application URLs
          APP_VERIFICATION_URL=${{ secrets.APP_VERIFICATION_URL }}
          APP_PASSWORD_RESET_URL=${{ secrets.APP_PASSWORD_RESET_URL }}
          APP_CDN_BASE_URL=${{ secrets.APP_CDN_BASE_URL }}
          APP_OAUTH2_AUTHORIZED_REDIRECT_URI=${{ secrets.APP_OAUTH2_AUTHORIZED_REDIRECT_URI }}
          GOOGLE_REDIRECT_URI=${{ secrets.GOOGLE_REDIRECT_URI }}
          KAKAO_REDIRECT_URI=${{ secrets.KAKAO_REDIRECT_URI }}
          EOF
          
          # docker-compose.yml ÏÉùÏÑ± (Í∞úÏÑ†Îêú Î≤ÑÏ†Ñ)
          cat > deploy-package/docker-compose.yml << 'EOF'
          version: '3.8'
          
          services:
            feedshop-backend:
              build: .
              container_name: feedshop-backend
              ports:
                - "8080:8080"
              env_file:
                - .env
              environment:
                - SPRING_PROFILES_ACTIVE=prod
              networks:
                - feedshop-network
              restart: unless-stopped
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
                interval: 30s
                timeout: 10s
                retries: 5
                start_period: 90s
              logging:
                driver: "json-file"
                options:
                  max-size: "10m"
                  max-file: "3"
          
          networks:
            feedshop-network:
              driver: bridge
          EOF
          
          # Í∞úÏÑ†Îêú Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏ ÏÉùÏÑ±
          cat > deploy-package/deploy.sh << 'EOF'
          #!/bin/bash
          
          set -e
          
          echo "=== FeedShop Backend Deployment Starting ==="
          echo "Timestamp: $(date)"
          
          # ÌòÑÏû¨ Ïª®ÌÖåÏù¥ÎÑà ÏÉÅÌÉú ÌôïÏù∏
          echo "Current container status:"
          sudo docker-compose ps || true
          
          # Í∏∞Ï°¥ Ïª®ÌÖåÏù¥ÎÑà Ï§ëÏßÄ Î∞è Ï†úÍ±∞ (Îçî ÏïàÏ†ÑÌïú Î∞©Î≤ï)
          echo "Stopping existing containers gracefully..."
          sudo docker-compose down --timeout 30 --remove-orphans || true
          
          # ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÎäî Ïù¥ÎØ∏ÏßÄ Ï†ïÎ¶¨
          echo "Cleaning up old images..."
          sudo docker system prune -f --filter "until=24h" || true
          
          # ÏÉà Ïª®ÌÖåÏù¥ÎÑà ÎπåÎìú Î∞è ÏãúÏûë
          echo "Building and starting new containers..."
          sudo docker-compose up -d --build --force-recreate
          
          # Ïª®ÌÖåÏù¥ÎÑà ÏãúÏûë ÎåÄÍ∏∞ (Îçî Ï∂©Î∂ÑÌïú ÏãúÍ∞Ñ)
          echo "Waiting for container to start..."
          sleep 30
          
          # Ïª®ÌÖåÏù¥ÎÑà ÏÉÅÌÉú Ïû¨ÌôïÏù∏
          echo "=== Container Status ==="
          sudo docker-compose ps
          echo ""
          
          # Ï¥àÍ∏∞ Î°úÍ∑∏ ÌôïÏù∏
          echo "=== Initial Container Logs ==="
          sudo docker-compose logs --tail=30 feedshop-backend
          echo ""
          
          # Îçî Ï†ïÍµêÌïú Ìó¨Ïä§Ï≤¥ÌÅ¨ (ÏµúÎåÄ 15Î∂Ñ, 30Ï¥à Í∞ÑÍ≤©)
          echo "Performing health check..."
          max_attempts=30
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "Health check attempt $attempt/$max_attempts..."
          
            # Ïª®ÌÖåÏù¥ÎÑàÍ∞Ä Ïã§Ìñâ Ï§ëÏù∏ÏßÄ ÌôïÏù∏
            if ! sudo docker-compose ps feedshop-backend | grep -q "Up"; then
              echo "‚ùå Container is not running!"
              sudo docker-compose logs --tail=50 feedshop-backend
              exit 1
            fi
          
            # HTTP Ìó¨Ïä§Ï≤¥ÌÅ¨
            if curl -f --connect-timeout 10 --max-time 30 http://localhost:8080/actuator/health > /dev/null 2>&1; then
              echo "‚úÖ Health check passed!"
              echo ""
              echo "=== Deployment Summary ==="
              echo "Service: FeedShop Backend"
              echo "Status: ‚úÖ Running"
              echo "Port: 8080"
              echo "Health Check: ‚úÖ Passed"
              echo "Timestamp: $(date)"
              echo ""
              echo "üéâ Deployment completed successfully!"
              exit 0
            else
              echo "‚è≥ Health check failed, waiting 30s... (attempt $attempt/$max_attempts)"
              if [ $attempt -eq $max_attempts ]; then
                echo ""
                echo "‚ùå Health check failed after $max_attempts attempts (15 minutes)"
                echo ""
                echo "=== Debugging Information ==="
                echo "Container status:"
                sudo docker-compose ps
                echo ""
                echo "Container logs (last 100 lines):"
                sudo docker-compose logs --tail=100 feedshop-backend
                echo ""
                echo "System resources:"
                df -h
                free -h
                echo ""
                exit 1
              fi
              sleep 30
            fi
          
            attempt=$((attempt + 1))
          done
          EOF
          
          chmod +x deploy-package/deploy.sh

      - name: Copy files to VM instance
        run: |
          echo "Copying deployment package to VM..."
          
          # VMÏóê Î∞∞Ìè¨ ÎîîÎ†âÌÑ∞Î¶¨ ÏÉùÏÑ±
          gcloud compute ssh $VM_INSTANCE_NAME \
            --zone=$VM_ZONE \
            --command="sudo mkdir -p $DEPLOY_PATH && sudo chown -R \$USER:\$USER $DEPLOY_PATH"
          
          # ÌååÏùº Î≥µÏÇ¨
          gcloud compute scp --recurse deploy-package/* \
            $VM_INSTANCE_NAME:$DEPLOY_PATH \
            --zone=$VM_ZONE

      - name: Deploy application on VM
        run: |
          echo "Deploying application on VM..."
          
          gcloud compute ssh $VM_INSTANCE_NAME \
            --zone=$VM_ZONE \
            --command="
              cd $DEPLOY_PATH && 
              echo '=== Starting deployment ===' &&
              chmod +x deploy.sh &&
              ./deploy.sh
            "

      - name: Verify deployment and setup monitoring
        run: |
          echo "Setting up external access and final verification..."
          
          # VMÏùò Ïô∏Î∂Ä IP Í∞ÄÏ†∏Ïò§Í∏∞
          VM_EXTERNAL_IP=$(gcloud compute instances describe $VM_INSTANCE_NAME \
            --zone=$VM_ZONE \
            --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
          
          echo "VM External IP: $VM_EXTERNAL_IP"
          
          # Î∞©ÌôîÎ≤Ω Í∑úÏπô ÌôïÏù∏/ÏÉùÏÑ±
          if ! gcloud compute firewall-rules describe allow-feedshop-8080 > /dev/null 2>&1; then
            echo "Creating firewall rule for port 8080..."
            gcloud compute firewall-rules create allow-feedshop-8080 \
              --allow tcp:8080 \
              --source-ranges 0.0.0.0/0 \
              --description "Allow FeedShop backend on port 8080"
          fi
          
          # ÏÑúÎπÑÏä§ URL ÏÑ§Ï†ï
          SERVICE_URL="http://$VM_EXTERNAL_IP:8080"
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_ENV
          
          echo ""
          echo "üîó Service URL: $SERVICE_URL"
          echo "üìä Health Check: $SERVICE_URL/actuator/health"
          echo "üìñ API Docs: $SERVICE_URL/swagger-ui/index.html"
          echo ""
          
          # Ïô∏Î∂ÄÏóêÏÑú ÏµúÏ¢Ö Ìó¨Ïä§Ï≤¥ÌÅ¨ (5Î∂Ñ ÎåÄÍ∏∞)
          echo "Performing external health check..."
          sleep 60  # Ï∂îÍ∞Ä ÎåÄÍ∏∞ ÏãúÍ∞Ñ
          
          for i in {1..5}; do
            if curl -f --connect-timeout 10 --max-time 30 "$SERVICE_URL/actuator/health" > /dev/null 2>&1; then
              echo "‚úÖ External health check passed!"
              break
            else
              echo "‚è≥ External health check attempt $i/5..."
              if [ $i -eq 5 ]; then
                echo "‚ö†Ô∏è External health check failed, but deployment may still be successful"
                echo "Please check manually: $SERVICE_URL/actuator/health"
              else
                sleep 60
              fi
            fi
          done

  notification:
    needs: deploy
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Notify Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "üöÄ Deployment to VM completed successfully!"
            echo "üìä Instance: ${{ env.VM_INSTANCE_NAME }}"
            echo "üåè Zone: ${{ env.VM_ZONE }}"
            echo "üîó URL: ${{ env.SERVICE_URL }}"
            echo ""
            echo "üîç Next steps:"
            echo "1. Check service health: ${{ env.SERVICE_URL }}/actuator/health"
            echo "2. View API docs: ${{ env.SERVICE_URL }}/swagger-ui/index.html"
            echo "3. Monitor logs: gcloud compute ssh ${{ env.VM_INSTANCE_NAME }} --zone=${{ env.VM_ZONE }} --command='sudo docker-compose -f ${{ env.DEPLOY_PATH }}/docker-compose.yml logs -f feedshop-backend'"
          else
            echo "‚ùå Deployment failed!"
            echo "Please check the deployment logs and troubleshoot."
            exit 1
          fi