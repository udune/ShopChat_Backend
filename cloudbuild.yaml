# FeedShop Backend - í¬íŠ¸í´ë¦¬ì˜¤ìš© Cloud Build ì„¤ì •
steps:
  # 1. Gradleì„ ì‚¬ìš©í•œ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
  - name: 'gradle:7.6-jdk17'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ”¨ Building Spring Boot application..."
        chmod +x ./gradlew
        ./gradlew clean build -x test
        echo "âœ… Build completed successfully"

  # 2. Docker ì´ë¯¸ì§€ ë¹Œë“œ (í˜„ì¬ commit SHAì™€ latest íƒœê·¸ ë™ì‹œ ìƒì„±)
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build',
      '-t', 'gcr.io/$PROJECT_ID/feedshop:$COMMIT_SHA',
      '-t', 'gcr.io/$PROJECT_ID/feedshop:latest',
      '.'
    ]

  # 3. Container Registryì— ì´ë¯¸ì§€ í‘¸ì‹œ
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/feedshop:$COMMIT_SHA']
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/feedshop:latest']

  # 4. Cloud Runì— ë°°í¬
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - 'feedshop'
      - '--image'
      - 'gcr.io/$PROJECT_ID/feedshop:$COMMIT_SHA'
      - '--region'
      - 'asia-northeast3'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'
      - '--port'
      - '8080'

      # í¬íŠ¸í´ë¦¬ì˜¤ìš© ë¦¬ì†ŒìŠ¤ ì„¤ì • (ë¹„ìš© ìµœì í™”)
      - '--memory'
      - '2Gi'
      - '--cpu'
      - '1'
      - '--max-instances'
      - '5'
      - '--min-instances'
      - '0'  # ë¯¸ì‚¬ìš© ì‹œ ì™„ì „ ì¢…ë£Œë¡œ ë¹„ìš© ì ˆì•½
      - '--concurrency'
      - '80'
      - '--timeout'
      - '300'

      # Spring Boot ê¸°ë³¸ í™˜ê²½ ë³€ìˆ˜
      - '--set-env-vars'
      - 'SPRING_PROFILES_ACTIVE=prod'
      - '--set-env-vars'
      - 'PORT=8080'
      - '--set-env-vars'
      - 'SERVER_ADDRESS=0.0.0.0'
      - '--set-env-vars'
      - 'SERVER_SSL_ENABLED=false'

      # ì• í”Œë¦¬ì¼€ì´ì…˜ë³„ í™˜ê²½ ë³€ìˆ˜
      - '--set-env-vars'
      - 'GCS_ID=$PROJECT_ID'  # í”„ë¡œì íŠ¸ ID ìë™ ì„¤ì •
      - '--set-env-vars'
      - 'GCS_BUCKET=feedshop-uploads'
      - '--set-env-vars'
      - 'DB_NAME=feedshop_db'
      - '--set-env-vars'
      - 'DB_USERNAME=cmall'
      - '--set-env-vars'
      - 'CDN_BASE_URL=https://cdn-feedshop.store'
      - '--set-env-vars'
      - 'MAIL_HOST=smtp.gmail.com'
      - '--set-env-vars'
      - 'MAIL_PORT=587'

      # Secret Managerì˜ ì‹œí¬ë¦¿ë“¤ (ë³´ì•ˆ ì •ë³´)
      - '--set-secrets'
      - 'DB_PASSWORD=db-password:latest'
      - '--set-secrets'
      - 'MAIL_USERNAME=gmail-username:latest'
      - '--set-secrets'
      - 'MAIL_PASSWORD=gmail-password:latest'
      - '--set-secrets'
      - 'MAILGUN_API_KEY=mailgun-api-key:latest'
      - '--set-secrets'
      - 'MAILGUN_DOMAIN=mailgun-domain:latest'
      - '--set-secrets'
      - 'MAILGUN_EMAIL=mailgun-email:latest'
      - '--set-secrets'
      - 'RECAPTCHA_SECRET_KEY=recaptcha-secret:latest'
      - '--set-secrets'
      - 'JWT_SECRET=jwt-secret:latest'
      - '--set-secrets'
      - 'OPENAI_API_KEY=openai-api-key:latest'
      - '--set-secrets'
      - 'GOOGLE_CLIENT_ID=google-client-id:latest'
      - '--set-secrets'
      - 'GOOGLE_CLIENT_SECRET=google-client-secret:latest'
      - '--set-secrets'
      - 'KAKAO_CLIENT_ID=kakao-client-id:latest'
      - '--set-secrets'
      - 'KAKAO_CLIENT_SECRET=kakao-client-secret:latest'

# ë¹Œë“œ ê²°ê³¼ë¬¼ ì´ë¯¸ì§€
images:
  - 'gcr.io/$PROJECT_ID/feedshop:$COMMIT_SHA'
  - 'gcr.io/$PROJECT_ID/feedshop:latest'

# ë¹Œë“œ ì˜µì…˜
options:
  machineType: 'E2_STANDARD_4'  # ì ì ˆí•œ ë¹Œë“œ ì„±ëŠ¥
  diskSizeGb: 100
  logging: CLOUD_LOGGING_ONLY

# íƒ€ì„ì•„ì›ƒ ì„¤ì • (20ë¶„)
timeout: '1200s'